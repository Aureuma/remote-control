<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SI Remote Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.5.0/css/xterm.min.css" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --error: #ef4444;
      --accent: #06b6d4;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: radial-gradient(circle at top, #1e293b 0%, #0f172a 45%, #020617 100%);
      color: var(--text);
      font-family: "SF Pro Text", "Segoe UI", sans-serif;
    }
    .layout {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100%;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(17, 24, 39, 0.85);
      backdrop-filter: blur(6px);
    }
    .badge {
      border: 1px solid rgba(6, 182, 212, 0.45);
      background: rgba(6, 182, 212, 0.12);
      color: #67e8f9;
      border-radius: 999px;
      font-size: 12px;
      padding: 4px 8px;
      letter-spacing: 0.2px;
    }
    #status {
      font-size: 13px;
      color: var(--muted);
    }
    #terminal {
      width: 100%;
      height: 100%;
      padding: 12px;
      box-sizing: border-box;
    }
    .footer {
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      padding: 8px 12px;
      background: rgba(2, 6, 23, 0.85);
    }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .error { color: var(--error); }
  </style>
</head>
<body>
<div class="layout">
  <div class="topbar">
    <div>
      <strong>SI Remote Control</strong>
      <span class="badge">Browser Terminal</span>
    </div>
    <div id="status">Connecting...</div>
  </div>
  <div id="terminal"></div>
  <div class="footer">Tip: rotate your phone for more columns. Read-only sessions ignore keyboard input.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xterm@5.5.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.10.0/lib/xterm-addon-fit.min.js"></script>
<script>
(() => {
  let ackBatchBytes = 262144;
  const ACK_FLUSH_MS = 120;
  const params = new URLSearchParams(window.location.search);
  let token = params.get("token") || "";
  let accessCode = params.get("code") || "";
  const requireCode = params.get("require_code") === "1";
  const statusEl = document.getElementById("status");

  const term = new Terminal({
    cursorBlink: true,
    convertEol: true,
    fontSize: 14,
    fontFamily: "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",
    theme: {
      background: "#0b1220",
      foreground: "#f8fafc",
      cursor: "#67e8f9"
    }
  });
  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(document.getElementById("terminal"));
  fitAddon.fit();

  let ws = null;
  let reconnectDelay = 500;
  let reconnectTimer = null;
  let readonly = false;
  let pendingAckBytes = 0;
  let ackTimer = null;

  function setStatus(text, cls) {
    statusEl.className = cls || "";
    statusEl.textContent = text;
  }

  function wsURL() {
    const proto = window.location.protocol === "https:" ? "wss" : "ws";
    return `${proto}://${window.location.host}/ws`;
  }

  function ensureAuthInputs() {
    if (!token) {
      const enteredToken = window.prompt("Enter access token");
      token = (enteredToken || "").trim();
      if (!token) {
        setStatus("Auth token required", "error");
        return false;
      }
    }
    if (requireCode && !accessCode) {
      const enteredCode = window.prompt("Enter access code");
      accessCode = (enteredCode || "").trim();
      if (!accessCode) {
        setStatus("Access code required", "error");
        return false;
      }
    }
    return true;
  }

  function sendAck(force) {
    if (ackTimer) {
      clearTimeout(ackTimer);
      ackTimer = null;
    }
    if (!pendingAckBytes) return;
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      return;
    }
    if (!force && pendingAckBytes < ackBatchBytes) {
      ackTimer = setTimeout(() => sendAck(true), ACK_FLUSH_MS);
      return;
    }
    ws.send(JSON.stringify({ type: "ack", bytes: pendingAckBytes }));
    pendingAckBytes = 0;
  }

  function queueAck(bytes) {
    if (!bytes || bytes <= 0) return;
    pendingAckBytes += bytes;
    if (pendingAckBytes >= ackBatchBytes) {
      sendAck(true);
      return;
    }
    if (!ackTimer) {
      ackTimer = setTimeout(() => sendAck(true), ACK_FLUSH_MS);
    }
  }

  function scheduleReconnect() {
    if (reconnectTimer) return;
    const wait = Math.min(reconnectDelay, 10000);
    reconnectTimer = setTimeout(() => {
      reconnectTimer = null;
      connect();
      reconnectDelay = Math.min(reconnectDelay * 2, 10000);
    }, wait);
  }

  function connect() {
    if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
      return;
    }
    ws = new WebSocket(wsURL());
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      if (!ensureAuthInputs()) {
        ws.close();
        return;
      }
      reconnectDelay = 500;
      setStatus("Connected", "ok");
      ws.send(JSON.stringify({ type: "auth", token, code: accessCode, columns: term.cols, rows: term.rows }));
      ws.send(JSON.stringify({ type: "resize", columns: term.cols, rows: term.rows }));
      sendAck(true);
    };

    ws.onmessage = (ev) => {
      if (ev.data instanceof ArrayBuffer) {
        const bytes = ev.data.byteLength;
        term.write(new Uint8Array(ev.data), () => queueAck(bytes));
        return;
      }
      let msg = null;
      try {
        msg = JSON.parse(ev.data);
      } catch {
        term.writeln(`\r\n${ev.data}`);
        return;
      }
      if (!msg || !msg.type) return;
      if (msg.type === "info" && msg.message) {
        term.writeln(`\r\n${msg.message}`);
      }
      if (msg.type === "readonly") {
        readonly = true;
        setStatus("Read-only", "warn");
      }
      if (msg.type === "auth_ok") {
        setStatus(readonly ? "Read-only" : "Live session", readonly ? "warn" : "ok");
      }
      if (msg.type === "prefs") {
        if (msg.bytes && msg.bytes > 0) {
          ackBatchBytes = msg.bytes;
        }
      }
      if (msg.type === "auth_error") {
        setStatus("Auth failed", "error");
        const lower = String(msg.message || "").toLowerCase();
        if (lower.includes("token")) {
          const enteredToken = window.prompt("Enter access token", token);
          token = (enteredToken || "").trim();
        }
        if (lower.includes("access code")) {
          const enteredCode = window.prompt("Enter access code", accessCode);
          accessCode = (enteredCode || "").trim();
        }
      }
      if (msg.type === "flow_pause") {
        setStatus("Slow network (paused)", "warn");
      }
      if (msg.type === "flow_resume") {
        setStatus(readonly ? "Read-only" : "Live session", readonly ? "warn" : "ok");
      }
      if (msg.type === "pong") {
        // app-level pong is optional, no action needed.
      }
    };

    ws.onclose = () => {
      setStatus("Disconnected. Reconnecting...", "error");
      scheduleReconnect();
    };

    ws.onerror = () => {
      setStatus("Connection error", "error");
    };
  }

  term.onData((data) => {
    if (readonly) return;
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      setStatus("Reconnecting...", "warn");
      return;
    }
    ws.send(JSON.stringify({ type: "input", data }));
  });

  function sendResize() {
    fitAddon.fit();
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "resize", columns: term.cols, rows: term.rows }));
    }
  }

  window.addEventListener("resize", sendResize);
  term.onResize(({ cols, rows }) => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "resize", columns: cols, rows }));
    }
  });

  connect();
})();
</script>
</body>
</html>
